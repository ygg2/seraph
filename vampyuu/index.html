<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bulma/0.7.5/css/bulma.min.css">
  <script defer src="https://use.fontawesome.com/releases/v5.3.1/js/all.js"></script>
  <style>
    [v-cloak]   { display: none; }
    .box {
      padding: 0;
      overflow: hidden;
      flex-basis: 100%;
      line-height: 0;
    }
    .cover-tile {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }
    .modal-image {
      position: fixed;
      max-width: 90vw;
      max-height: 90vh;
    }
  </style>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no, minimal-ui">
  <title>Seraph of the End</title>
</head>
<body>
  <main id="app" v-cloak>
  
    <section class="section">
      <div class="container">
        <nav class="breadcrumb" aria-label="breadcrumbs">
          <ul>
            <li><a href="../">Seraph</a></li>
            <li class="is-active"><a href="#" aria-current="page">Vamp Yuu</a></li>
          </ul>
        </nav>
        <div class="level">
          <div class="level-left">
            <h1 class="title level-item">Vampire Yuu Content</h1>
          </div>
          <div class="field level-right">
            <search-bar @search="search"></search-bar>
          </div>
        </div>
        <p v-show="invalidTag">No tags match that search.</p>
        <div class="tags">
          <span v-for="query of queries" class="tag is-medium">
            {{ query }}&nbsp;
            <button class="delete is-small" @click="remove(query)"></button>
          </span>
        </div>
        <div class="columns is-vcentered is-multiline">
          <div v-for="image of results" class="column is-3">
            <div class="box" @click="openModal(image)">
              <img :src="image.src">
            </div>
          </div>
        </div>
        <div v-show="!queries.size">
          <div
            style="padding-bottom: 24px"
            v-for="group of groups"
            :key="group.name"
          >
            <component :is="group.layout" :images="group.images"></component>
          </div>
        </div>
      </div>
    </section>

    <div v-if="modal!=null" class="modal is-active">
      <div class="modal-background" @click="closeModal"></div>
      <img :src="modal.src" class="modal-image">
    </div>
  
  </main>

  <script src="https://cdn.jsdelivr.net/npm/vue@2.x/dist/vue.min.js"></script>
  <script>
    Vue.component('image-box', {
      props: {
        src: String
      },
      template: `
      <div class="tile is-child box" @click="$root.openModal(src)">
        <img class="cover-tile" :src="src.src" loading="lazy">
      </div>
      `,
    })

    Vue.component('box-layout-any', {
      props: {
        images: Array
      },
      template: `
      <div class="tile is-ancestor">
        <div v-for="img of images" :key="img" class="tile is-parent">
          <image-box :src="img"></image-box>
        </div>
      </div>
      `
    })

    Vue.component('box-layout-3', {
      props: {
        images: Array
      },
      template: `
        <div class="tile is-ancestor">
          <div class="tile is-parent is-3">
            <image-box :src="images[0]"></image-box>
          </div>
          <div class="tile is-parent is-6">
            <image-box :src="images[1]"></image-box>
          </div>
          <div class="tile is-parent is-3">
            <image-box :src="images[2]"></image-box>
          </div>
        </div>
      `
    })

    Vue.component('box-layout-4', {
      props: {
        images: Array
      },
      template: `
      <div class="tile is-ancestor">
        <div class="tile is-parent is-3 is-vertical">
          <image-box :src="images[0]"></image-box>
          <image-box :src="images[1]"></image-box>
        </div>
        <div class="tile is-parent">
          <image-box :src="images[2]"></image-box>
        </div>
        <div class="tile is-parent is-3">
          <image-box :src="images[3]"></image-box>
        </div>
      </div>
      `
    })

    Vue.component('box-layout-6', {
      props: {
        images: Array
      },
      template: `
      <div class="tile is-ancestor">
        <div class="tile">
          <div class="tile is-parent">
            <image-box :src="images[0]"></image-box>
          </div>
          <div class="tile is-parent is-vertical">
            <image-box :src="images[1]"></image-box>
            <image-box :src="images[2]"></image-box>
          </div>
        </div>
        <div class="tile is-vertical">
          <div class="tile">
            <div class="tile is-parent">
              <image-box :src="images[3]"></image-box>
            </div>
            <div class="tile is-parent">
              <image-box :src="images[4]"></image-box>
            </div>
          </div>
          <div class="tile">
            <div class="tile is-parent">
              <image-box :src="images[5]"></image-box>
            </div>
          </div>
        </div>
      </div>
      `
    })

    Vue.component('box-layout-5', {
      props: {
        images: Array
      },
      template: `
      <div class="tile is-ancestor">
        <div class="tile is-9 is-vertical">
          <div class="tile">
            <div class="tile is-parent is-8">
              <image-box :src="images[0]"></image-box>
            </div>
            <div class="tile is-parent">
              <image-box :src="images[1]"></image-box>
            </div>
          </div>
          <div class="tile">
            <div class="tile is-parent is-4">
              <image-box :src="images[2]"></image-box>
            </div>
            <div class="tile is-parent">
              <image-box :src="images[3]"></image-box>
            </div>
          </div>
        </div>
        <div class="tile is-parent">
          <image-box :src="images[4]"></image-box>
        </div>
      </div>
      `
    })

    Vue.component('search-bar', {
      props: {
        images: Array
      },
      template: `
      <div class="field has-addons">
        <div class="control has-icons-left">
          <input
            class="input"
            type="search"
            v-model="query"
            @keyup.enter="search"
          >
          <span class="icon is-small is-left">
            <i class="fas fa-search fa-xs"></i>
          </span>
        </div>
        <div class="control">
          <button type="submit" class="button" @click="search">Search</button>
        </div>
      </div>
      `,
      data() {
        return {
          query: '',
          aliases: new Map([
            ['beach', /\b:?wi:?\b|beach/],
            ['only yuu', /(?:only|just) yuu|yuu only/],
            ['mika', /mika(?:ela|yuu)?|yuumika/],
            ['vampire mika', /vamp.*(?=mikayuu|yuumika|mika)/],
            ['reversal', /revers.*|jida mika/],
            ['5 min', /(?:5|five).?min/],
            ['blood drinking', /blood ?(?:drink|shar|suck)|wine/],
            ['come crashing', /come crashing|\bcc\b/],
            ['color', /color(?:ed|ing)?/],
            ['lineless paper', /(?:unlined|unruled)|paper (?:without|no) lines/]
          ])
        }
      },
      methods: {
        search() {
          let query = this.query.toLowerCase();
          let invalidTag = true;
          if (this.aliases.get(query)) {
            invalidTag = false;
            this.$emit('search', query);
          } else {
            for (let [key, value] of this.aliases) {
              if (value.test(query)) {
                invalidTag = false;
                if (key == 'mika' && this.aliases.get('vampire mika').test(query)) continue;
                this.$emit('search', key);
              }
            }
          }
          this.$root.invalidTag = invalidTag;
          this.query = '';
        }
      }
    })

    var app = new Vue({
      el: '#app',
      data: {
        modal: null,
        queries: new Set(),
        results: [],
        invalidTag: false,
        groups: [
        {
            name: 'General 3',
            layout: 'box-layout-3',
            images: [
              { src: 'buildings.jpg', tags: ['mika', 'vampire mika', '5 min'] },
              { src: 'cuddle.jpg', tags: ['mika', 'vampire mika'] },
              { src: 'trail_mix.jpg', tags: ['only yuu'] },
            ]
          },
          {
            name: 'General',
            layout: 'box-layout-6',
            images: [
              { src: 'beach.jpg', tags: ['mika', 'vampire mika', 'beach', 'blood drinking'] },
              { src: 'hug.jpg', tags: ['mika', 'vampire mika'] },
              { src: 'vamps.jpg', tags: ['mika', 'vampire mika'] },
              { src: 'vamp_yuu.jpg', tags: ['only yuu', 'lineless paper', 'color'] },
              { src: 'wip_blood.jpg', tags: ['only yuu'] },
              { src: 'lying_down.jpg', tags: ['only yuu'] },
            ]
          },
          {
            name: 'General 2',
            layout: 'box-layout-4',
            images: [
              { src: 'hand_drink.jpg', tags: ['mika', 'vampire mika', 'blood drinking'] },
              { src: 'hand_drink_variant.jpg', tags: ['mika', 'reversal', 'blood drinking'] },
              { src: 'hoods.jpg', tags: ['mika', 'vampire mika'] },
              { src: 'fridge.jpg', tags: ['mika', 'vampire mika', 'blood drinking','come crashing'] },
            ]
          },
          {
            name: '5-Minute Mikayuu',
            layout: 'box-layout-5',
            images: [
              { src: 'overgrown.jpg', tags: ['mika', 'vampire mika', '5 min'] },
              { src: 'nuzzle.jpg', tags: ['mika', 'vampire mika', '5 min'] },
              { src: 'noble_saves_witch.jpg', tags: ['mika', '5 min'] },
              { src: 'reversal.jpg', tags: ['mika', 'reversal', '5 min'] },
              { src: 'v_is_for.jpg', tags: ['mika', 'vampire mika', '5 min'] }
            ]
          },
          {
            name: 'Mikayuu Week',
            layout: 'box-layout-any',
            images: [
              { src: 'small_vamp.jpg', tags: ['only yuu', 'lineless paper'] },
              { src: 'not_my_blood_type.jpg', tags: ['mika', 'vampire mika', 'blood drinking', 'lineless paper'] },
              { src: 'come_crashing.jpg', tags: ['mika', 'vampire mika', 'come crashing', 'lineless paper'] },
              { src: 'lin_art.jpg', tags: ['mika', 'vampire mika', 'lineless paper'] }
            ]
          },
          {
            name: 'Desktop',
            layout: 'box-layout-5',
            images: [
              { src: 'desktop_5.png', tags: ['mika', 'vampire mika', 'blood drinking', 'color', 'lineless paper'] },
              { src: 'desktop_2.png', tags: ['only yuu', 'color', 'lineless paper'] },
              { src: 'desktop_3.png', tags: ['mika', 'vampire mika', 'color', 'lineless paper'] },
              { src: 'desktop_4.png', tags: ['mika', 'vampire mika', 'color', 'lineless paper'] },
              { src: 'desktop_1.png', tags: ['only yuu', 'lineless paper'] },
            ]
          }
        ]
      },
      methods: {
        openModal(image) {
          document.documentElement.classList.add("is-clipped");
          this.modal = image;
        },
        closeModal() {
          document.documentElement.classList.remove("is-clipped");
          this.modal = null;
        },
        search(term) {
          this.queries.add(term);
          this.refresh();
        },
        remove(term) {
          this.queries.delete(term);
          this.refresh();
        },
        refresh() {
          this.results = [];
          if (this.queries.size) {
            for (let group of this.groups) {
              for (let image of group.images) {
                let match = true
                let imageTags = new Set(image.tags);
                for (let query of this.queries) {
                  if (!imageTags.has(query)) {
                    match = false;
                  }
                }
                if (match) this.results.push(image);
              }
            }
          }
        }
      }
    })
  </script>
</body>
</html>